<!-- 
The MIT License (MIT)

Copyright (c) 2017 Zalando SE

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

Uitleg
"quadrant": 0,    - 0,1,2,3 (tegen de klok in, begint rechtsonder)
"ring": 0,        - 0,1,2,3 (start vanuit de binnenste ring)
"label": "",      - labelnaam
"link": "",       - link naar documentatie
"active": true,   - zichtbaar ja of nee
"status": ""      - onverander:0, nieuw:1, verplaats=2

WiGo4IT Kleuren: 
  Roze    : #BB4EAC
  Groen   : #66D08F
  Blauw   : #00116E
  Oranje  : #E67968
  Wigo4it groen: #005452
 SIIA Kleuren: 
  --kleur-achtergrond: #f2f8f6; 
  --kleur-tekst: black; 
  --kleur-doing: #007351; 
  --kleur-ongoing: #66ab96; 
  --kleur-planning: #9f7ba9; 
  --kleur-undoing: #5f236f; 
  
  
  
  
-->

<!DOCTYPE html>
<html lang="nl">

<head>

<meta http-equiv="Content-type" content="text/html; charset=utf-8">
<meta name="description" content="SIIA Radar">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
  <meta charset="UTF-8">

<title>SIIA Radar</title>

<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="manifest" href="/icons/site.webmanifest">
<link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#5bbad5">
<link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
<link rel="stylesheet" href="radar.css">

<script type="text/javascript" src="https://js.monitor.azure.com/scripts/b/ext/ai.clck.2.min.js"></script>
<script type="text/javascript">
var clickPluginInstance = new Microsoft.ApplicationInsights.ClickAnalyticsPlugin();
  // Click Analytics configuration
var clickPluginConfig = {
    autoCapture : true,
    dataTags : {
        customDataPrefix : 'data-custom-',
        aiBlobAttributeTag : 'customblob',
        parentDataTag : 'parent-group',
        donotTrackDataTag : 'dnt',
        captureAllMetaDataContent : true,
        useDefaultContentNameOrId : true
    }
}
// Application Insights configuration
var configObj = {
    connectionString: "InstrumentationKey=7954e6d3-c28e-4314-9a32-b1c36990eaaa;IngestionEndpoint=https://westeurope-5.in.applicationinsights.azure.com/;LiveEndpoint=https://westeurope.livediagnostics.monitor.azure.com/;ApplicationId=5719656a-4c41-4eb9-a992-adc536d704e9",
    // Alternatively, you can pass in the instrumentation key,
    // but support for instrumentation key ingestion will end on March 31, 2025.
    // instrumentationKey: "YOUR INSTRUMENTATION KEY",
    extensions: [
        clickPluginInstance
    ],
    extensionConfig: {
        [clickPluginInstance.identifier] : clickPluginConfig
    },
};
// Application Insights JavaScript (Web) SDK Loader Script code
!(function (cfg){function e(){cfg.onInit&&cfg.onInit(n)}var x,w,D,t,E,n,C=window,O=document,b=C.location,q="script",I="ingestionendpoint",L="disableExceptionTracking",j="ai.device.";"instrumentationKey"[x="toLowerCase"](),w="crossOrigin",D="POST",t="appInsightsSDK",E=cfg.name||"appInsights",(cfg.name||C[t])&&(C[t]=E),n=C[E]||function(g){var f=!1,m=!1,h={initialize:!0,queue:[],sv:"8",version:2,config:g};function v(e,t){var n={},i="Browser";function a(e){e=""+e;return 1===e.length?"0"+e:e}return n[j+"id"]=i[x](),n[j+"type"]=i,n["ai.operation.name"]=b&&b.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(h.sv||h.version),{time:(i=new Date).getUTCFullYear()+"-"+a(1+i.getUTCMonth())+"-"+a(i.getUTCDate())+"T"+a(i.getUTCHours())+":"+a(i.getUTCMinutes())+":"+a(i.getUTCSeconds())+"."+(i.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z",iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}},ver:undefined,seq:"1",aiDataContract:undefined}}var n,i,t,a,y=-1,T=0,S=["js.monitor.azure.com","js.cdn.applicationinsights.io","js.cdn.monitor.azure.com","js0.cdn.applicationinsights.io","js0.cdn.monitor.azure.com","js2.cdn.applicationinsights.io","js2.cdn.monitor.azure.com","az416426.vo.msecnd.net"],o=g.url||cfg.src,r=function(){return s(o,null)};function s(d,t){if((n=navigator)&&(~(n=(n.userAgent||"").toLowerCase()).indexOf("msie")||~n.indexOf("trident/"))&&~d.indexOf("ai.3")&&(d=d.replace(/(\/)(ai\.3\.)([^\d]*)$/,function(e,t,n){return t+"ai.2"+n})),!1!==cfg.cr)for(var e=0;e<S.length;e++)if(0<d.indexOf(S[e])){y=e;break}var n,i=function(e){var a,t,n,i,o,r,s,c,u,l;h.queue=[],m||(0<=y&&T+1<S.length?(a=(y+T+1)%S.length,p(d.replace(/^(.*\/\/)([\w\.]*)(\/.*)$/,function(e,t,n,i){return t+S[a]+i})),T+=1):(f=m=!0,s=d,!0!==cfg.dle&&(c=(t=function(){var e,t={},n=g.connectionString;if(n)for(var i=n.split(";"),a=0;a<i.length;a++){var o=i[a].split("=");2===o.length&&(t[o[0][x]()]=o[1])}return t[I]||(e=(n=t.endpointsuffix)?t.location:null,t[I]="https://"+(e?e+".":"")+"dc."+(n||"services.visualstudio.com")),t}()).instrumentationkey||g.instrumentationKey||"",t=(t=(t=t[I])&&"/"===t.slice(-1)?t.slice(0,-1):t)?t+"/v2/track":g.endpointUrl,t=g.userOverrideEndpointUrl||t,(n=[]).push((i="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",o=s,u=t,(l=(r=v(c,"Exception")).data).baseType="ExceptionData",l.baseData.exceptions=[{typeName:"SDKLoadFailed",message:i.replace(/\./g,"-"),hasFullStack:!1,stack:i+"\nSnippet failed to load ["+o+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(b&&b.pathname||"_unknown_")+"\nEndpoint: "+u,parsedStack:[]}],r)),n.push((l=s,i=t,(u=(o=v(c,"Message")).data).baseType="MessageData",(r=u.baseData).message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+l+")").replace(/\"/g,"")+'"',r.properties={endpoint:i},o)),s=n,c=t,JSON&&((u=C.fetch)&&!cfg.useXhr?u(c,{method:D,body:JSON.stringify(s),mode:"cors"}):XMLHttpRequest&&((l=new XMLHttpRequest).open(D,c),l.setRequestHeader("Content-type","application/json"),l.send(JSON.stringify(s)))))))},a=function(e,t){m||setTimeout(function(){!t&&h.core||i()},500),f=!1},p=function(e){var n=O.createElement(q),e=(n.src=e,t&&(n.integrity=t),n.setAttribute("data-ai-name",E),cfg[w]);return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=a,n.onerror=i,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||a(0,t)},cfg.ld&&cfg.ld<0?O.getElementsByTagName("head")[0].appendChild(n):setTimeout(function(){O.getElementsByTagName(q)[0].parentNode.appendChild(n)},cfg.ld||0),n};p(d)}cfg.sri&&(n=o.match(/^((http[s]?:\/\/.*\/)\w+(\.\d+){1,5})\.(([\w]+\.){0,2}js)$/))&&6===n.length?(d="".concat(n[1],".integrity.json"),i="@".concat(n[4]),l=window.fetch,t=function(e){if(!e.ext||!e.ext[i]||!e.ext[i].file)throw Error("Error Loading JSON response");var t=e.ext[i].integrity||null;s(o=n[2]+e.ext[i].file,t)},l&&!cfg.useXhr?l(d,{method:"GET",mode:"cors"}).then(function(e){return e.json()["catch"](function(){return{}})}).then(t)["catch"](r):XMLHttpRequest&&((a=new XMLHttpRequest).open("GET",d),a.onreadystatechange=function(){if(a.readyState===XMLHttpRequest.DONE)if(200===a.status)try{t(JSON.parse(a.responseText))}catch(e){r()}else r()},a.send())):o&&r();try{h.cookie=O.cookie}catch(k){}function e(e){for(;e.length;)!function(t){h[t]=function(){var e=arguments;f||h.queue.push(function(){h[t].apply(h,e)})}}(e.pop())}var c,u,l="track",d="TrackPage",p="TrackEvent",l=(e([l+"Event",l+"PageView",l+"Exception",l+"Trace",l+"DependencyData",l+"Metric",l+"PageViewPerformance","start"+d,"stop"+d,"start"+p,"stop"+p,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),h.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4},(g.extensionConfig||{}).ApplicationInsightsAnalytics||{});return!0!==g[L]&&!0!==l[L]&&(e(["_"+(c="onerror")]),u=C[c],C[c]=function(e,t,n,i,a){var o=u&&u(e,t,n,i,a);return!0!==o&&h["_"+c]({message:e,url:t,lineNumber:n,columnNumber:i,error:a,evt:C.event}),o},g.autoExceptionInstrumented=!0),h}(cfg),(C[E]=n).queue&&0===n.queue.length?(n.queue.push(e),n.trackPageView({})):e();})({                
  src: "https://js.monitor.azure.com/scripts/b/ai.3.gbl.min.js",
  crossOrigin: "anonymous",
  // sri: false, // Custom optional value to specify whether fetching the snippet from integrity file and do integrity check
  cfg: configObj // configObj is defined above.
});
</script>

</head>

<body>

<style>
  /* Styles for buttons and modal */
  #edit-mode-toggle { margin-left: 15px; padding: 5px 10px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; }
  #edit-mode-toggle.active { background-color: #e0f2f7; border-color: #007351; }
  #add-label-btn { margin-left: 10px; padding: 5px 10px; cursor: pointer; border-radius: 4px; border: 1px solid #007351; background-color: #007351; color: white; }
  .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:none; justify-content: center; align-items: center; z-index:1000; }
  .modal-content { background: white; padding: 25px; border-radius:8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width:90%; max-width:500px; position:relative; }
  .modal-close-btn { position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; cursor:pointer; line-height:1; }
</style>

<div style="text-align:center; margin:20px; position:relative;">
  <h1>SIIA Radar</h1>
  <div id="user-menu" style="position:absolute; top:10px; right:10px;">
    <!-- Auth menu injected here -->
    <button id="edit-mode-toggle" style="display:none;">Edit Mode</button>
    <button id="add-label-btn" style="display:none;">Add New Label</button>
    <button id="canvas-btn" onclick="window.top.location.href='/canvas'" style="margin-left: 10px; padding: 5px 10px; cursor: pointer; border-radius: 4px; border: 1px solid var(--kleur-doing); background-color: var(--kleur-doing); color: white;">Go to Canvas</button>
        <!-- Personal workspace -->
        <button id="my-radar-btn"
                style="margin-left:10px; padding:5px 10px; cursor:pointer;
                       border-radius:4px; border:1px solid #007351;
                       background:#007351; color:#fff;">
            Mijn Radar
        </button>
  </div>
</div>

<svg id="radar" width="1700" height="900" style="display:block; margin:auto;"></svg>

<div class="center-box">
  <div class="column">
    <h3>Wat is de SIIA-radar</h3>
    <p>
    De <em>Sustainable IT Impact Assessment Radar</em>, de SIIA-Radar, is onderdeel van het </a href="https://siia.coalitieduurzamedigitalisering.nl">Sustainable IT Impact Assessment</a> van de <a href="https://www.coalitieduurzamedigitalisering.nl">Nederlandse Coalitie Duurzame Digitalisering</a>
    </p>
    <p>
      De SIIA-Radar bevat een lijst van activiteiten om de IT te verduurzamen en de processen in de organisatie die de IT ondersteunt. De activiteiten worden geplaatst in een <em>ring</em>. Er zijn vier ringen met de volgende karakteristieken:
    </p>
    <ul>
    <li><strong style="color: var(--kleur-doing)">DOING</strong> &mdash; Dit zien we graag en hebben we doorgevoerd.</li>
    <li><strong style="color: var(--kleur-ongoing)">ONGOING</strong> &mdash; Hier zijn we mee bezig en <em>willen</em> we overal gaan doorvoeren. </li>
    <li><strong style="color: var(--kleur-planning)">PLANNING</strong> &mdash; Dit onderzoeken we en <em>kan</em> interessant zijn.  </li>
    <li><strong style="color: var(--kleur-undoing)">UNDOING</strong> &mdash; Dit is verleden tijd en kan <em>écht</em> niet meer.</li>
    </ul>
  
    <h3>Wat is het doel?</h3>
    <p>
    De SIIA-radar is bedoeld om organisaties te helpen om de IT zo in te richten dat die  helpt om te verduurzamen en de IT zelf te verduurzamen.
    </p>
    <p>
    De SIIA-radar geeft een overzicht van de activiteiten die daarvoor nodig zijn en de prioriteiten daarin. Het helpt om alignment te creëren binnen organisatie rondom het thema duurzaamheid. 
    </p>
    <p>
    De activiteiten staan in 4 kwadranten: 
    <ul>
    <li>verduurzamen van de <strong>organisatie</strong>: business-model, doelen en strategie</li>
    <li>verduurzamen van de <strong>IT</strong></li>
    <li>verduurzamen van de <strong>processen</strong> in de organisatie</li>
    <li>verduurzamen van de <strong>werkvloer</strong>: alles wat nodig is om het (IT-)werk  te kunnen doen. Zoals: reizen, telefoon en laptop, eten en drinken, gebouw en meubilair, verwarming en verlichting, thuiswerken. </li>
   </ul>
    </p>
    <h3>Waar komt de informatie in de radar vandaan?</h3>
    <p>
    De items in deze radar zijn afkomstig  van de duurzaamheidsradar van <a href="https://www.duurzaamheidsradar.wigo4it.nl">WiGo4IT</a>, die intern al een aantal jaren de analyse heeft gedaan hoe ze moeten verduurzamen. 
    </p>
    <p>
    WiGo4IT is een dienstverlener, in 2004 opgericht door gemeenten, om mensen van uitkeringen te voorzien. Per maand doet WiGo4IT meer dan 100.000 betalingen en in al die jaren is dat altijd precies op tijd gelukt. De organisatie telt zo'n 70 medewerkers. De werkcultuur van WiGo4IT is in de duurzaamheidsradar terug te vinden: het is een organisatie die de nadruk legt op autonomie en eigen verantwoordelijkheid. En veel van de activiteiten helpen de eigen medewerkers, maar ook hun klanten, de gemeenten, om die verantwoordelijkheid voor duurzaamheid te nemen.
    </p>
    </div>
    <div class="column">
    
    <h3>Wie bepaalt de prioriteiten in de radar?</h3>
    <p>
      De inhoud van de SIIA-radar wordt vastgesteld door de personen die verantwoordelijk zijn voor het verduurzamen van de organisatie. In een agile werkende organisatie zullen dat de Sustainable Champions zijn. Het is de bedoeling dat teamleden in gesprek gaan als er iets verkeerd of niet op staat.
      
      Om de SIIA-radar te vullen kunnen drie routes worden bewandeld:
        <ul>
        <li>Je hebt  ideeën om de IT en de processen die de IT ondersteunt te verduurzamen: bijvoorbeeld het energieverbruik te verminderen, de GHG emissies te verlagen, de milieu- en sociale impact van de IT te verminderen door apparatuur te verminderen. Kijk dan in hoofdstuk <strong>'Doe'</strong> van de SIIA. Je gaat dan onderzoeken waar jullie staan wat duurzaamheid van IT en de processen die de IT ondersteunt, waar je naar toe wilt wat duurzaamheid betreft en wat daarvoor moet gebeuren. Van daaruit ga je kijken wat nodig is om de IT betrouwbaar, flexibel en veilig te houden als je aan de slag gaat met verduurzamen. Kijk daarvoor in het hoofdstuk <strong>'Organiseer'</strong>. 
        Bij de verduurzaming komen waarschijnlijk nieuwe vragen op: is er behoefte aan de organisatie in een verduurzamende samenleving en economie? Hoe zorg je dat klanten graag zaken met je doen, als je verduurzaamt? Hoe belangrijk is verduurzaming om medewerkers aan te trekken, voor financiers of andere belanghebbenden. Kijk voor deze vragen in het hoofdstuk <strong>'Denk' </strong></li>
        <li>De organisatie waar je werkt wil verduurzamen en jij bent verantwoordelijk voor de IT en de duurzaamheid daarvan. Hoe breng je in kaart welke IT nodig is, om de verduurzamende organisatie te ondersteunen. Misschien is de IT belemmerend en zijn veranderingen noodzakelijk. Kijk dan in het hoofdstuk <strong>'Organiseer'van de SIIA</strong></li>
        <li>Je bent verantwoordelijk om de organisatie te verduurzamen en je wilt je daar daar over kunnen verantwoorden. Misschien om morele redenen, om juridische redenen (de Europese CSRD, de Corporate Governance Code) of omdat je afnemers of toeleveranciers dat van je vragen. Je vraagt je af waar je moet beginnen: moet het businessmodel aangepast, de strategie, wat moet er dan allemaal veranderen in de organisatie? Begin dan in het hoofdstuk <strong>'Denk'</strong> van de SIIA</li>
        <li>Je bent verantwoordelijk voor de rapportage naar klanten en andere belanghebbenden (toezichthouders, financiers, bestuurders) over de verduurzaming van de organisatie. De SIIA loopt alle hoofdstukken door van de rapportage. Te beginnen met het onderzoek naar de impact op duurzaamheid van de organisatie en wat de kansen en bedreigingen zijn als de economie en samenleving verduurzaamt. Dan de aanpassingen die nodig zijn en de risico's en onzekerheden die de transformatie naar duurzaamheid hinderen en hoe die worden beheerst. Vervolgens gaat de SIIA in op de eisen die aan de IT gesteld moeten worden om deze transitie te verduurzamen te ondersteunen en daarbij zelf duurzaam, veilig, betrouwbaar en flexibel te blijven. Tenslotte laat de SIIA verschillende best practices zien om aspecten van de organisatie te verduurzamen: de inkoop, het energieverbruik, de emissies enz.</li>
        </ul>      
    </p>
    <p>
      Vorige versies kan je hier vinden: <a href="changelog.html">Changelog</a>
    </p>
    <p>
      <em>Gebaseerd op: <a href="https://duurzaamheidsradar.wigo4it.nl">WiGo4IT Duurzaamheidsradar</a> & <a href="https://www.thoughtworks.com/radar">ThoughtWorks</a> & <a href="https://github.com/zalando/tech-radar"> Zalando TechRadar</a></em>
    </p>
  </div>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script>window.enableQuickMenu = false;</script>

<script src="radar.js"></script>
  <script>
    let currentRadarAbort;
    var deletedItemIdForDebug = null;
    // Global state management
    window.lastLoadedConfig = {
      title: 'SIIA Radar',
      entries: [],
      uniqueGroups: [],
      editMode: false,
      quadrants: [ // Default quadrant names
        { name: "IT voor verduurzaming" },
        { name: "Duurzaam Werken" },
        { name: "Duurzame Organisatie" },
        { name: "Duurzame IT" },
      ],
      rings: [ // Default ring names
        { name: "DOING" },
        { name: "ONGOING" },
        { name: "PLANNING" },
        { name: "UNDOING" }
      ],
      // Hardcoded user ID for local development
      userId: '478aaa60-2a14-48d5-8cd0-d0cf9558d584' 
    };

    // Resolve correct PHP path for localhost vs production
    function api(relative){
        return (window.location.hostname === 'localhost' ? 'api/' : '') + relative;
    }

    // --- Data Transformation ---
    function mapStatusRingToIndex(status) {
        // Maps the text status from the database to a 0-based ring index
        const mapping = {
            'ADOPT': 0,   // DOING
            'TRIAL': 1,   // ONGOING
            'ASSESS': 2,  // PLANNING
            'HOLD': 3,    // UNDOING
            'AVOID': 3    // Also map AVOID to UNDOING
        };
        // Return the mapped index, or a default/error value if not found
        const index = mapping[status];
        return index !== undefined ? index : 3; // Default to the outermost ring
    }

    // --- Data Fetching ---
    function loadAndDisplayRadar() {
      const userId = window.lastLoadedConfig.userId;
      if (!userId) {
        console.error("User ID is not set. Cannot fetch data.");
        return;
      }
      
      const isMyRadarPage = window.location.pathname.includes('mijnradar.html');

      // --- PUBLIC LANDING: load static JSON straight away ---
      if (!isMyRadarPage) {
          loadFromLocalJson();
          return;
      }

      // --- PERSONAL WORKSPACE: keep using the PHP API ---
      fetch(api(`labels.php?user_id=${userId}`))
        .then(r => (r.ok ? r.json() : Promise.reject(new Error(r.statusText))))
        .then(data => processPhpResponse(data))
        .catch(err => {
            console.warn('[Radar] PHP fetch failed, falling back to JSON –', err.message);
            loadFromLocalJson();
        });

      /* ---------- helpers ------------ */
      function processPhpResponse(data){
          // keep only WiGo4IT's default set
          const DEFAULT_IDS = Array.from({length:69}, (_,i)=>259+i);
          const entries = data.filter(l=>DEFAULT_IDS.includes(Number(l.id)))
              .map(l=>({
                   quadrant: +l.quadrant,
                   ring: mapStatusRingToIndex(l.status_ring),
                   label: l.label,
                   group: l.group,
                   link: 'wiki.html?title='+encodeURIComponent(l.label),
                   id: l.id,
                   moved:0,
                   active: l.active!==0 && l.active!==false
              }));
          render(entries);
      }

      function loadFromLocalJson(){
          fetch('versions/2024-11.json')
            .then(r=>r.ok?r.json():Promise.reject('missing json'))
            .then(json=>{
                 let id=259;
                 const entries=json.map(it=>({
                     quadrant:+((it.quadrant ?? it.old_quadrant) ?? 0),
                     ring:+it.ring||0,
                     label:it.label,
                     group:it.group||it.radarcat||'N/A',
                     link:'wiki.html?title='+encodeURIComponent(it.label),
                     id:id++,
                     moved:0,
                     active:true
                 }));
                 render(entries);
            })
            .catch(e=>{
                document.getElementById('radar').innerHTML=`<p style='color:red;text-align:center;'>Error loading static labels: ${e}</p>`;
            });
      }

      function render(entries){
          // Partition and assign displayId
          const seg=[[[],[],[],[]],[[],[],[],[]],[[],[],[],[]],[[],[],[],[]]];
          let disp=1;
          entries.forEach(e=>seg[e.quadrant][e.ring].push(e));
          for(const q of [2,3,1,0]) for(let r=0;r<4;r++) for(const e of seg[q][r]) e.displayId=disp++;

          window.lastLoadedConfig.entries=entries;
          radar_visualization(window.lastLoadedConfig);
      }
    }

    // --- UI and Event Listeners ---
    function initializeUI() {
        const menu = document.getElementById('user-menu');
    
            // --- Ensure a user label is visible ---
            if (menu && !document.getElementById('user-name')) {
                const userSpan = document.createElement('span');
                userSpan.id = 'user-name';
                userSpan.style.marginRight = '8px';
                menu.prepend(userSpan);
            }
    
            // --- Wire-up Edit toggle and Add button ---
            const editToggleBtn = document.getElementById('edit-mode-toggle');
            const addLabelBtn   = document.getElementById('add-label-btn');
            const canvasBtn     = document.getElementById('canvas-btn');
    
            // New: flag – are we on the personal workspace?
            const isMyRadarPage = window.location.pathname.includes('mijnradar.html');
    
            if (editToggleBtn) {
                if (isMyRadarPage) {
                    editToggleBtn.style.display = 'inline-block';
                    editToggleBtn.addEventListener('click', toggleEditMode);
                } else {
                    editToggleBtn.style.display = 'none';
                }
            }
    
            if (addLabelBtn) {
                if (isMyRadarPage) {
                    addLabelBtn.onclick = () => openModal();
                } else {
                    addLabelBtn.style.display = 'none';
                }
            }
    
            // Canvas button hidden on default landing page
            if (canvasBtn) {
                canvasBtn.style.display = isMyRadarPage ? 'inline-block' : 'none';
            }
    
            /* --- Mijn Radar navigation --- */
            const myRadarBtn = document.getElementById('my-radar-btn');
            if (myRadarBtn) {
                myRadarBtn.onclick = () => window.location.href = 'mijnradar.html';
            }
    
            updateEditUI(); // reflect initial state
        }
    
        // Update button visibility/text based on current mode
        function updateEditUI() {
            const isEdit = window.lastLoadedConfig.editMode;
            const addLabelBtn   = document.getElementById('add-label-btn');
            const editToggleBtn = document.getElementById('edit-mode-toggle');
    
            if (addLabelBtn) {
                addLabelBtn.style.display = isEdit ? 'inline-block' : 'none';
            }
    
            if (editToggleBtn) {
                editToggleBtn.textContent = isEdit ? 'View' : 'Edit';
                editToggleBtn.title       = isEdit ? 'Return to viewing mode' : 'Switch to edit mode';
            }
        }
    
        // Toggle between viewing and editing modes
        function toggleEditMode() {
            window.lastLoadedConfig.editMode = !window.lastLoadedConfig.editMode;
            updateEditUI();
            loadAndDisplayRadar(); // re-render visualization with new mode
    }

    // --- Main Execution ---
    document.addEventListener('DOMContentLoaded', () => {
      initializeUI();
      loadAndDisplayRadar();
    });

  </script>

<!-- Add/Edit Label Modal -->
<div id="label-modal" class="modal-overlay">
  <div class="modal-content">
    <button class="modal-close-btn" onclick="closeModal()">&times;</button>
    <h3 id="modal-title">Label Details</h3>
    <form id="label-form">
      <input type="hidden" id="label-id">
      <div><label>Label:</label><input type="text" id="label-name" required></div>
      <div><label>Quadrant:</label><select id="label-quadrant" required></select></div>
      <div><label>Ring:</label><select id="label-ring" required></select></div>
      <div><label>Theme:</label><select id="label-theme" required></select></div>
      <div><label>Wiki Link:</label><input type="text" id="label-link"></div>
      
      <!-- New Message Area for Modal -->
      <div id="label-modal-message" style="color: red; margin-top: 10px; text-align: left;"></div>

      <div style="margin-top:20px;text-align:right;">
        <button type="button" onclick="closeModal()">Cancel</button>
        <button type="button" id="delete-label-btn" style="float:left;display:none;">Delete</button>
        <button type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

  <script>
  // --- Modal control & form handlers ---
  function openModal(d) { // 'd' is the label data object for editing, undefined for adding
    const isEditing = d !== undefined && d !== null;

    // Get form elements
    const modal = document.getElementById('label-modal');
    const modalTitle = document.getElementById('modal-title');
    const labelIdInput = document.getElementById('label-id');
    const labelNameInput = document.getElementById('label-name');
    const labelQuadrantSelect = document.getElementById('label-quadrant');
    const labelRingSelect = document.getElementById('label-ring');
    const labelThemeSelect = document.getElementById('label-theme');
    const labelLinkInput = document.getElementById('label-link');
    const deleteButton = document.getElementById('delete-label-btn');

    // Set Title
    modalTitle.textContent = isEditing ? 'Edit Label' : 'Add New Label';

    // Populate/Reset basic fields
    labelIdInput.value = isEditing ? d.id : '';
    labelNameInput.value = isEditing ? d.label : '';
    labelLinkInput.value = isEditing ? d.link : '';

    // --- Populate Dropdowns ---
    // Quadrants (0-3)
    labelQuadrantSelect.innerHTML = ''; // Clear existing
    const quadrants = window.lastLoadedConfig?.quadrants || [];
    quadrants.forEach((q, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = `${index}: ${q.name}`;
      if (isEditing && d.quadrant === index) {
        option.selected = true;
      }
      labelQuadrantSelect.appendChild(option);
    });

    // Rings (0-3)
    labelRingSelect.innerHTML = ''; // Clear existing
    const rings = window.lastLoadedConfig?.rings || [];
    rings.forEach((r, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = `${index}: ${r.name}`;
      if (isEditing && d.ring === index) {
        option.selected = true;
      }
      labelRingSelect.appendChild(option);
    });

    // Themes (use uniqueGroups from global config)
    labelThemeSelect.innerHTML = ''; // Clear existing
    const themes = window.lastLoadedConfig?.uniqueGroups || [];
    themes.forEach(theme => {
      const option = document.createElement('option');
      option.value = theme;
      option.textContent = theme;
      if (isEditing && d.group === theme) {
        option.selected = true;
      }
      labelThemeSelect.appendChild(option);
    });

    // --- Show/Hide Delete Button ---
    deleteButton.style.display = isEditing ? 'inline-block' : 'none';

    // Display the modal
    modal.style.display = 'flex';
  }
  function closeModal(){ document.getElementById('label-modal').style.display='none'; }
  document.getElementById('label-form').onsubmit = async e=>{
    e.preventDefault();
    const id = document.getElementById('label-id').value;
    let payload = {
        label: document.getElementById('label-name').value,
        quadrant: +document.getElementById('label-quadrant').value,
        ring: +document.getElementById('label-ring').value,
        group: document.getElementById('label-theme').value,
            link: document.getElementById('label-link').value,
            supabase_user_id: window.lastLoadedConfig.userId
    };
    const isEditing = !!id;

        let url = isEditing ? api('update_label.php') : api('create_label.php');
    if (isEditing) {
        payload.id = id; // Add id to payload for update
    }
    
    // Clear previous messages and disable button (optional, for better UX)
    const modalMessageArea = document.getElementById('label-modal-message'); // Assuming you add a message area div
    if (modalMessageArea) {
        modalMessageArea.textContent = '';
        modalMessageArea.className = 'modal-message'; // Reset class
    }

    try {
        const response = await fetch(url, {
            method: 'POST', // Use POST for both create and update
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
        });

        if (!response.ok) {
            // Try to parse error JSON, then fall back to status text
            let errorDetail = `Request failed with status: ${response.status}`;
            try {
                const errData = await response.json();
                if (errData.errors && Array.isArray(errData.errors)) {
                    errorDetail = errData.errors.map(er => er.msg).join(', ');
                } else if (errData.error) {
                    errorDetail = errData.error;
                }
            } catch (parseError) { /* Ignore if body isn't JSON or empty */ }
            throw new Error(errorDetail);
        }

        // If response.ok, proceed
        closeModal(); 
        loadAndDisplayRadar();

    } catch (error) {
        console.error('Error saving label:', error);
        if (modalMessageArea) {
            modalMessageArea.textContent = error.message;
            modalMessageArea.className = 'modal-message error'; // Add error class for styling
        } else {
            alert('Error saving label: ' + error.message); // Fallback to alert
        }
    }
  };
  document.getElementById('delete-label-btn').onclick = async () =>{
    const id = document.getElementById('label-id').value;
    if(!confirm('Delete?')) return;
        const res = await fetch(api('delete_label.php'), {
        method: 'POST', // Use POST for reliability
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id: id })
    });
    if(res.ok){ closeModal(); deletedItemIdForDebug=id; loadAndDisplayRadar(); } else alert('Delete failed');
  };
  </script>

</body>
</html> 
